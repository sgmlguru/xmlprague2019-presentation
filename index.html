<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

	    <title>Merging The Swedish Code of Statutes (SFS)</title>

	    <link rel="stylesheet" href="css/reveal.css" />
	    <link rel="stylesheet" href="css/theme/white.css" />
	    <link rel="stylesheet" href="css/ari.css" />

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css"/>

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
            <div class="slides">
                <section data-background="img/Sveriges_riksdag_fr_vasabron.JPG" data-background-size="100%">
                    <h1 style="color: white;">Merging The Swedish Code of Statutes (SFS)</h1>
                    
                    <h4 style="color: white;">XML Prague 2019</h4>
                    <p style="color: white;">Ari Nordström | ari.nordstrom@gmail.com</p>
                    
                    <!--<img class="stretch" src="img/law-books.jpg"/>-->
                    
                </section>
                
                
                
                <!-- START of intro to companies merge and SFS merge project slides -->
                
                <section>
                    
                    <!-- KG buys NJ -->
                    <section>
                        
                        <h3>Karnov Group Buys Norstedts juridik</h3>
                        
                        <img src="img/office_space_at_karnov_group_DEFAULT_2_1.jpg"/>
                        
                        <aside class="notes">
                            <p>2017: KG buys NJ</p>
                            <p>Merge companies (UGH)</p>
                        </aside>
                    </section>
                    
                    
                    <section style="color: white;" data-background="img/orange-fish-blue-fish.jpg">
                        <h3 style="color: white;">Merging companies</h3>
                        <ul>
                            <li class="fragment">systems</li>
                            <li class="fragment">information</li>
                        </ul>
                        
                        <!-- Insert suitable image -->
                        <!--<img class="stretch" src="img/orange-fish-blue-fish.jpg"/>-->
                        
                        <aside class="notes">
                            <p>Merge systems (double UGH)</p>
                            <p>Merge information (well, that's what I want to talk about here)</p>
                        </aside>
                    </section>
                    
                    
                    <!-- What SFS is -->
                    <section>
                        
                        <blockquote>
                            <p>The Swedish Code of Statutes (Swedish: Svensk författningssamling; SFS) is the official law code of Sweden which contains the statutes and ordinances enacted and designated by the Government, including a publication of all new Swedish laws enacted by the Riksdag.</p>
                        </blockquote>
                        
                        <p><a href="https://www.svenskforfattningssamling.se/english.html">https://www.svenskforfattningssamling.se/english.html</a></p>
                        
                        <aside class="notes">
                            <p>~10,000 documents, about half of them in force</p>
                        </aside>
                    </section>
                    
                    
                    <!-- What KG and NJ do with SFS -->
                    <section>
                        
                        <h3>The Swedish Code of Statutes (SFS)</h3>
                        
                        <img src="img/law-books.jpg"/>
                        
                        <p class="fragment">Annotated and published by both companies</p>
                        
                        <aside class="notes">
                            <p>Annotated and published by both companies</p>
                            <p>Online offerings</p>
                            <p>NJ Printed law book</p>
                        </aside>
                    </section>
                    
                    
                    <!-- The basics of SFS -->
                    <section>
                        
                        <h3>SFS 1962:700</h3>
                        
                        <table>
                            <tbody>
                                <tr>
                                    <td>
                                        <h6>§ 1</h6>
                                        <p>...</p>
                                    </td>
                                    <td>
                                        <p class="fragment">KG Annotation</p>
                                        <p class="fragment">NJ Annotation</p>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <h6>§ 2</h6>
                                        <p>...</p>
                                    </td>
                                    <td>
                                        <p class="fragment">KG Annotation</p>
                                        <p class="fragment">NJ Annotation</p>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <h6>§ 3</h6>
                                        <p>...</p>
                                    </td>
                                    <td>
                                        <p class="fragment">KG Annotation</p>
                                        <p class="fragment">NJ Annotation</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <aside class="notes">
                            <p>The law is (well, should be) the same</p>
                            <p>Both companies offer their additions</p>
                            <p>Commentary, links, ...</p>
                        </aside>
                        
                    </section>
                    
                    
                    <!-- Common online platform -->
                    <section>
                        <h3>Common Online Platform</h3>
                        
                        <img src="img/pro-platform.png"/>
                        
                        <aside class="notes">
                            <p>This is the current Karnov platform</p>
                        </aside>
                    </section>
                    
                    
                    <!-- Printed book -->
                    <section>
                        <h3>Printed Law Book</h3>
                        
                        <img src="img/lagbok992.jpg"/>
                        
                        <aside class="notes">
                            <p>NJ's flagship product!</p>
                        </aside>
                    </section>
                    
                </section>
                
                <!-- END of intro to companies merge and SFS merge project slides -->
                
                
                
                <!-- START of what you need to understand first -->
                
                <section>
                    <h3>What You Need to Understand First</h3>
                    
                    <!-- Image of PDF source -->
                    <img class="stretch" src="img/sfs-1971-235-text.png"/>
                    
                    <aside class="notes">
                        <p>PDF sources</p>
                        <p>Guessed semantics</p>
                        <p>MS Word and other sources?</p>
                    </aside>
                </section>
                
                <!-- END of what you need to understand first -->
                
                
                
                
                <!-- START of approach -->
                
                <section>
                    
                    <!-- Approach -->
                    <section>
                        <h3>Approach</h3>
                        
                        <!-- Suitable image -->
                        <img class="stretch" src="img/kg-nj-exc-kgp.png"/>
                    </section>
                    
                    <!-- Source DTDs -->
                    <section data-background="img/nj-dtd.png" data-background-size="100%">
                        <h1>Norstedts DTD</h1>
                    </section>
                    
                    <section data-background="img/kd-dtd.png" data-background-size="100%">
                        <h1>Karnov DTD</h1>
                    </section>
                    
                    <!-- Create exchange format -->
                    <section data-background="img/exchange-dtd.png" data-background-size="100%">
                        <h1>Exchange DTD</h1>
                    </section>
                    
                    <!-- Create authoring format (KG++) -->
                    <section data-background="img/kgpp-dtd.png" data-background-size="100%">
                        <h1>KG++ DTD</h1>
                    </section>
                    
                    <!-- Convert KG and NJ to EXC -->
                    <section data-background="img/kg2exc-pipeline.png">
                        
                        <!-- Pipelines heading here? -->
                        <h1>KG to EXC</h1>
                        <h1>NJ to EXC</h1>
                        
                        <aside class="notes">
                            <p>KG: 59 steps as I write this</p>
                            <p>NJ: 58 steps</p>
                        </aside>
                    </section>
                    
                    <!-- Diff (Delta XML's XML Compare) -->
                    <section data-background="img/xml-compare.png">
                        <h1>Diffing</h1>
                        <h2>Delta XML's XML Compare</h2>
                    </section>
                    
                    <!-- Merge -->
                    <section data-background="img/sfs-merge-pipeline.png">
                        <h1>SFS Merge pipeline</h1>
                        
                        <aside class="notes">
                            <p>54 steps</p>
                        </aside>
                    </section>
                    
                    <!-- Convert EXC to KG++ -->
                    <section data-background="img/exc2kgp-pipeline.png">
                        <h1>EXC to KG++</h1>
                        
                        <aside class="notes">
                            <p>A mere 16 steps</p>
                            <p>KG++ stricter subset of EXC</p>
                        </aside>
                    </section>
                    
                    <!-- BUT: Legacy publishing at NJ -->
                    <section data-background="img/law-books.jpg">
                        <h1 style="color: white;">NJ Legacy publishing</h1>
                        <h5 class="fragment" style="color: white;">The Printed Law Book</h5>
                        
                        <aside class="notes">
                            <p>KG++ to EXC ~15 steps</p>
                            <p>EXC to NJ ongoing</p>
                            <p>XML to IDML to PDF process</p>
                            <p>Buys us time</p>
                        </aside>
                    </section>
                    
                    <!-- KG++ to EXC to old NJ -->
                    
                    
                </section>
                
                <!-- END of approach -->
                
                
                
                
                <!-- START of tools -->
                
                <section>
                    
                    <!-- Tools -->
                    <section data-background="img/german-beer-pipeline.jpg">
                        <h2 style="color: white">Tools</h2>
                        
                        <!-- Suitable image -->
                    </section>
                    
                    <!-- I'm an XProc fan -->
                    <section>
                        <h5>I'm a (Data) Pipelines Fan</h5>
                        
                        <img src="img/bruges-beer-pipeline.jpg"/>
                        
                        <aside class="notes">
                            <p>XProc Workshop before conf</p>
                            <p>Publishing, data conversions, ...</p>
                            <p>DTD, Schematron validation</p>
                            <p>Unit tests with XSpec</p>
                        </aside>
                    </section>
                    
                    <!-- Nic's XProc Tools -->
                    <section>
                        <h5>Nic Gibson's XProc Tools</h5>
                        <!--<p><a href="https://github.com/Corbas/xproc-tools">https://github.com/Corbas/xproc-tools</a></p>-->
                        
                        <pre class="stretch">
                            <code class="xml" data-trim data-noescape>    &lt;xsl:template match="/">
        &lt;xsl:apply-templates select="node()" mode="SFS-EXC2KG_INLINE"/>
    &lt;/xsl:template>
    
    &lt;xsl:template match="exc:ref" mode="SFS-EXC2KG_INLINE">
        &lt;kgp:ref>
            &lt;xsl:copy-of select="@* except @type"/>
            &lt;xsl:if test="@type">
                &lt;xsl:attribute name="target-type" select="@type"/>
            &lt;/xsl:if>
            &lt;xsl:apply-templates select="node()" mode="SFS-EXC2KG_INLINE"/>
        &lt;/kgp:ref>
    &lt;/xsl:template>
    
    &lt;!-- ID transform -->
    &lt;xsl:template match="node()" mode="SFS-EXC2KG_INLINE">
        &lt;xsl:copy copy-namespaces="no">
            &lt;xsl:copy-of select="@*"/>
            &lt;xsl:apply-templates select="node()" mode="SFS-EXC2KG_INLINE"/>
        &lt;/xsl:copy>
    &lt;/xsl:template></code>
                        </pre>
                        
                        <aside class="notes">
                            <p>XProc Workshop before conf</p>
                            <p>Pipelined approach to XSLT transforms</p>
                            <p>Each step does one thing (plus ID transform)</p>
                        </aside>
                    </section>
                    
                    <!-- Manifest example -->
                    <section>
                        <h5>XSLT Pipeline Manifest</h5>
                        
                        <pre class="stretch">
                            <code class="xml" data-trim data-noescape>&lt;manifest
    xmlns="http://www.corbas.co.uk/ns/transforms/data"
    xml:base="."
    description="This converts Exchange XML to KG++ format">
    
    &lt;group description="Unmatched also need to be grouped">
        &lt;item
            href="../sfsmerge/SFS-EXC-MERGE_group.xsl"
            description="Group unmatched; merged will not be touched"/>
        &lt;item
            href="../sfsmerge/SFS-EXC-MERGE_no-level-group.xsl"
            description="Group group dividers without @level and their following siblings (non-recursive)"/>
    &lt;/group>
    
    &lt;group
        description="KG-specific steps"
        xml:base=".">
        &lt;!-- Converts main structures -->
        &lt;item
            href="SFS-EXC2KG_structure.xsl"
            description="Converts main EXC structures"/>
        
        &lt;!-- Chapter versions to meta -->
        &lt;item
            href="SFS-EXC2KG_version2meta.xsl"
            description="Converts EXC chapter version information to KG++ meta items"/>
        
        &lt;!-- Group title versions if there are two or more consecutive title groups -->
        &lt;item
            href="SFS-EXC2KG_merge-title-versions.xsl"
            description="Merges the versions of two or more consecutive title groups"/>
        
        &lt;!-- Front matter -->
        &lt;item
            href="SFS-EXC2KG_front.xsl"
            description="Converts front matter elements, except those that only need a namespace conversion"/>
        
        &lt;!-- In-force info -->
        &lt;item
            href="SFS-EXC2KG_in-force.xsl"
            description="Converts in-force elements"/>
        
        &lt;!-- Various body- and chapter-level elements -->
        &lt;item
            href="SFS-EXC2KG_body.xsl"
            description="Converts various body- and chapter-level elements"/>
        
        &lt;!-- Para- and subpara-level elements -->
        &lt;item
            href="SFS-EXC2KG_paras.xsl"
            description="Converts para- and subpara-level elements"/>
        
        &lt;!-- Title elements -->
        &lt;item
            href="SFS-EXC2KG_title-grp.xsl"
            description="Converts title elements"/>
        
        &lt;!-- Block-level -->
        &lt;item
            href="SFS-EXC2KG_block-level.xsl"
            description="Converts block-level elements"/>
        
        &lt;!-- Annotations -->
        &lt;item
            href="SFS-EXC2KG_annotations.xsl"
            description="Converts annotations (both redanm and kommentar)"/>
        
        &lt;!-- Inline elements -->
        &lt;item
            href="SFS-EXC2KG_inline.xsl"
            description="Converts inline elements"/>
        
        &lt;!-- EXC namespace to KG++ namespace -->
        &lt;item
            href="SFS-EXC2KG_namespace-conversion.xsl"
            description="Converts the EXC namespace to the KG++ namespace"/>
        
        &lt;!-- Convert various IDs to LOGIDs -->
        &lt;item
            href="SFS-EXC2KG_id-logid.xsl"
            description="Converts IDs to LOGIDs"/>
        
        &lt;!-- Attrs -->
        &lt;item
            href="SFS-EXC2KG_attrs.xsl"
            description="Converts various attributes"/>
    &lt;/group>
    
&lt;/manifest></code>
                        </pre>
                        
                        <aside class="notes">
                            <p>1 item/1 XSLT</p>
                            <p>All you have to do is to move them around</p>
                        </aside>
                    </section>
                    
                    <!-- Debug example -->
                    <section>
                        <h5>Debug</h5>
                        
                        <pre class="stretch">
                            <code class="xml" data-trim data-noescape>8.2M Jan 18 11:34 0-SFS1962-0700.xml
8.2M Jan 18 11:34 1-SFS-EXC-MERGE_group.xsl.xml
8.2M Jan 18 11:34 2-SFS-EXC-MERGE_no-level-group.xsl.xml
8.2M Jan 22 09:17 3-SFS-EXC2KG_structure.xsl.xml
8.3M Jan 22 09:17 4-SFS-EXC2KG_version2meta.xsl.xml
8.2M Jan 22 09:17 5-SFS-EXC2KG_merge-title-versions.xsl.xml
8.3M Jan 22 09:17 6-SFS-EXC2KG_front.xsl.xml
8.2M Jan 22 09:17 7-SFS-EXC2KG_in-force.xsl.xml
8.3M Jan 22 09:17 8-SFS-EXC2KG_body.xsl.xml
8.3M Jan 22 09:17 9-SFS-EXC2KG_paras.xsl.xml
8.6M Jan 22 09:17 10-SFS-EXC2KG_title-grp.xsl.xml
8.8M Jan 22 09:17 11-SFS-EXC2KG_block-level.xsl.xml
8.3M Jan 22 09:17 12-SFS-EXC2KG_annotations.xsl.xml
9.8M Jan 22 09:17 13-SFS-EXC2KG_inline.xsl.xml
8.1M Jan 22 09:17 14-SFS-EXC2KG_namespace-conversion.xsl.xml
8.1M Jan 22 09:17 15-SFS-EXC2KG_id-logid.xsl.xml
7.9M Jan 22 09:17 16-SFS-EXC2KG_attrs.xsl.xml</code>
                        </pre>
                        
                    </section>
                    
                    <!-- Delta XML -->
                    
                    <!-- Diff Example -->
                    <section>
                        <h3>XML Compare</h3>
                        <h4>DeltaXML</h4>
                        <pre class="stretch">
                            <code class="xml" data-trim data-noescape>&lt;exc:para deltaxml:deltaV2="A!=B">
    &lt;deltaxml:attributes deltaxml:deltaV2="B">
        &lt;dxa:kg-process
            deltaxml:deltaV2="B">
            &lt;deltaxml:attributeValue deltaxml:deltaV2="B"
                >@logid="SFS2004-0046.K3.P3.S1" @num="1"
                @chgbardate="20161101"&lt;/deltaxml:attributeValue>
        &lt;/dxa:kg-process>
        &lt;dxa:id
            deltaxml:deltaV2="B">
            &lt;deltaxml:attributeValue deltaxml:deltaV2="B"
                >SFS2004-0046.K3.P3.S1&lt;/deltaxml:attributeValue>
        &lt;/dxa:id>
    &lt;/deltaxml:attributes>Fondbolaget
    och förvaringsinstitutet ska ingå ett skriftligt avtal som reglerar förhållandet mellan
    parterna. Avtalet ska bland annat reglera det informationsutbyte och den samordning som krävs
    för att institutet ska kunna utföra sina uppgifter för fondens räkning i enlighet med kraven i
    denna lag och andra författningar.
    &lt;deltaxml:textGroup deltaxml:deltaV2="A">
        &lt;deltaxml:text
            deltaxml:deltaV2="A"> &lt;/deltaxml:text>
    &lt;/deltaxml:textGroup>
    &lt;exc:ref deltaxml:deltaV2="B"
        source="kg" href="SFS2004-0046.N94" role="notreferens-KAR" number="94"/>
    &lt;exc:change-sfs-grp deltaxml:deltaV2="A" source="nj" role="2016:892">
        &lt;exc:change-sfs publish-type="online">
            &lt;exc:para>Lag (2016:892).&lt;/exc:para>
        &lt;/exc:change-sfs>
        &lt;exc:change-sfs publish-type="print">
            &lt;exc:para>&lt;exc:emph type="bold">Lag 2016:892&lt;/exc:emph> (se vid 4:15).&lt;/exc:para>
        &lt;/exc:change-sfs>
    &lt;/exc:change-sfs-grp>
&lt;/exc:para></code>
                        </pre>
                        
                        <aside class="notes">
                            <p></p>
                        </aside>
                        
                    </section>
                    
                </section>
                
                <!-- END of tools -->
                
                
                
                
                <!-- START of BODY of the talk -->
                
                <!-- How I produced EXC (and KG++) -->
                <!-- Info analysis of SFS statutes -->
                <section>
                    <h3>(Limited) Information Analysis</h3>
                    
                    <!-- Screenshots of BrB, others -->
                    
                    <aside class="notes">
                        <p>Look at the law book, web (less bias)</p>
                        <p>4 sample documents for PoC</p>
                    </aside>
                </section>
                
                <!-- 4 "typical" source docs as PoC -->
                
                <!-- Look at NJ sources -->
                <!-- Wrote EXC, reviewed by colleagues -->
                <section>
                    <h3>NJ Sources</h3>
                    
                    <!-- Looked at NJ sources first -->
                    <!-- Wrote NJ2EXC conversion, first version -->
                </section>
                <!-- Wrote NJ2EXC draft 1 -->
                
                
                <!-- Wrote KG2EXC, draft 1 -->
                <section>
                    <h3>KG sources</h3>
                    
                    <!-- Wrote equivalent KG2EXC conversion -->
                    <!-- VERY different results! -->
                </section>
                
                <!-- Rinse and repeat -->
                <section>
                    <h3>Rinse &amp; Repeat</h3>
                    
                    <!-- Tweak transforms to produce the same basic semantics in the output -->
                </section>
                
                <!-- Expanding on the PoC -->
                <!-- All 1960s SFS docs  -->
                
                <!-- Uploaded to eXist-DB -->
                <!-- Lots of queries and reports -->
                <section>
                    <h3>(Lots of) eXist Queries</h3>
                    
                    <pre>
                        <code class="xquery" data-trim data-noescape>xquery version "3.1";

let $base := '/db/sfs/nj'
let $moment := <docs>{
    for $doc in collection($base)//sfs[.//sfskapitel//moment]
        return $doc
}</docs>

return <docs count="{count($moment//sfs)}">{
    $moment/node()
}</docs></code>
                    </pre>
                    
                    <aside class="notes">
                        <p>Simple queries</p>
                        <p>But a lot of them</p>
                    </aside>
                </section>
                
                
                <!-- Planned upconversions -->
                
                
                <!-- Issues, solutions -->
                <!-- Upconversions: -->
                <!-- Running headers -->
                <!-- Grouping -->
                <!-- List types -->
                
                
                <!-- Diff the sources for the first time -->
                <section>
                    <h3>Properly Diffing for the First Time</h3>
                    
                    <img src="img/diffed-sfs.png" class="stretch"/>
                    
                    <aside class="notes">
                        <p>Wrote XProc pipeline for diff</p>
                        <p>Optionally outputs HTML reports</p>
                    </aside>
                </section>
                
                <!-- HTML report, quickly spot where the basic diffs are -->
                <!-- SHOW diff example -->
                
                
                <!-- This allowed me to start writing merge steps -->
                
                <!-- A few words about Delta XML keys -->
                <!-- Normative vs non-normative (parts, chapters, paras, subparas...) -->
                
                <!-- Text refs vs xrefs -->
                <!-- Merge preferences -->
                <!-- NJ annotations -->
                <!-- KG notrefs -->
                <!--  -->
                <!-- Config -->
                
                
                <!-- END of BODY of the talk -->
                
                
                
                
                <!-- START of Conclusions -->
                
                <section>
                    
                    <section style="color: white" data-background="img/riksdagshuset.png">
                        
                        <h3 style="color: white">Conclusions</h3>
                        
                        <ul>
                            <li>It's doable!</li>
                            <li class="fragment">Manual selections necessary</li>
                            <li class="fragment">Most problems cultural rather than technical</li>
                        </ul>
                    </section>
                    
                    <section>
                        <h5>Thank you</h5>
                        <img class="stretch" src="img/annie-quote.png"/>
                    </section>
                    
                </section>
                
                <!-- END of Conclusions -->
                
            </div>
        </div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
